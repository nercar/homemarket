<!-- Main row -->
<div class="row">
	<!-- Despachos WEB Pendientes -->
	<div class="col-12 mt-2" id="div_tbl_datos">
		<div class="card card-primary elevation-2 border border-dark pb-1">
			<div class="card-header txtcomp d-flex p-1 pl-1 mb-1 align-items-baseline">
				<i class="fas fa-dolly mr-1"></i>Entrega de Mercancía Facturada&nbsp;
				<div class="ml-auto mr-1">Entrega #:</div>
				<input type="text" name="id_cab" id="id_cab" class="form-control form-control-sm bg-info text-center"
						disabled readonly style="width: 75px; height: 25px">
			</div>
			<div class="card-body p-0 m-0 w-100">
				<form action="" onsubmit="return false" class="col form-inline align-baseline">
					<label class="m-0 p-0 mr-3 text-muted"><em>Sucursal <span id="ttitulo"></span></em></label>
					<label for="nrodoc" class="m-0 p-0 mr-1">Nro. Doc:</label>
					<input style="display: none;" placeholder="#Doc.">
					<input type="number" class="form-control form-control-sm text-center mr-1" id="nrodoc" value=""
						style="height: 25px; width: 100px;" autocomplete="off" placeholder="#Doc.">
					<label for="nrocaja" class="m-0 p-0 ml-1 mr-1">Caja:</label>
					<input style="display: none;" placeholder="#Caja">
					<input type="number" class="form-control form-control-sm text-center mr-2" id="nrocaja" value=""
						style="height: 25px; width: 100px;" autocomplete="off" placeholder="#Caja">
					<button class="btn btn-sm btn-primary p-0 pl-1 pr-1 m-0" type="submit" onclick="buscarFactura()">
						<i class="fas fa-search"></i> Consultar
					</button>
				</form>
				<table width="100%" class="table-striped table-hover table-bordered" id="tblDocumentos">
					<thead>
						<tr>
							<th width="5%"  class="text-center txtcomp bg-warning-gradient">Nro.Doc</th>
							<th width="5%"  class="text-center txtcomp bg-warning-gradient">Caja</th>
							<th width="15%" class="text-center txtcomp bg-warning-gradient">Fecha</th>
							<th width="15%" class="text-center txtcomp bg-warning-gradient">Rif</th>
							<th width="40%" class="text-center txtcomp bg-warning-gradient">Cliente</th>
							<th width="20%" class="text-center txtcomp bg-warning-gradient">Teléfono</th>
						</tr>
					</thead>
				</table>
				<table width="100%" class="table-striped table-hover table-bordered" id="tblDetalle">
					<thead>
						<tr>
							<th width="10%" class="text-center txtcomp bg-dark-gradient">Código</th>
							<th width="50%" class="text-center txtcomp bg-dark-gradient">Descripción</th>
							<th width="10%" class="text-center txtcomp bg-dark-gradient">Vendido</th>
							<th width="10%" class="text-center txtcomp bg-dark-gradient">Pendiente</th>
							<th width="10%" class="text-center txtcomp bg-dark-gradient">Entregar</th>
							<th width="10%" class="text-center txtcomp bg-dark-gradient">Opciones</th>
						</tr>
					</thead>
				</table>
			</div>
			<div class="card-footer row p-1 m-0 col-12">
				<table align="center" class="m-0 p-0 table-bordered col-md-5 col-12" cellpadding="0" cellspacing="0">
					<tr style="line-height: 1.2em; letter-spacing: -0.8px;" class="bg-dark">
						<th class="text-center" width="30%">Total Ítems</th>
						<th class="text-center" width="35%">Vendido</th>
						<th class="text-center" width="35%">Entregar</th>
					</tr>
					<tr style="line-height: 1.2em; letter-spacing: -0.8px;" class="bg-warning-gradient">
						<th class="text-center" id="titems">&nbsp;</th>
						<th class="text-center" id="totven">&nbsp;</th>
						<th class="text-center" id="totent">&nbsp;</th>
					</tr>
				</table>
				<button class="btn btn-primary ml-auto mr-auto col-md-3 col-5" data-toggle="modal"
					data-target="#TblArt" disabled="true" id="agrArt">
					<i class="fas fa-plus-circle"></i> Agregar Artículo
				</button>
				<button class="btn btn-success ml-auto mr-auto col-md-3 col-6" disabled onclick="procEntrega()" id="procEntrega">
					<i class="fas fa-check"></i> Procesar Entrega
				</button>
			</div>
			<!-- /.card-body -->
		</div>
	</div>
	<!-- /.col -->
</div>

<!-- Modal lista de articulos -->
<div class="modal fade" id="TblArt" style="z-index: 9888;" tabindex="-1" role="dialog" aria-labelledby="TblArtLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-centered">
		<!-- Modal content-->
		<div class="modal-content">
			<div class="modal-header bg-primary pt-1 pb-1">
				<h4 class="modal-title txtcomp">Seleccione un Artículo para Agregarlo a la Lista</h4>
			</div>
			<div class="modal-body p-0" id="contTblArt">
				<form action="" onsubmit="return false;" class="form-inline col-12 p-0 m-0 mt-2">
					<div class="d-flex w-100 align-content-center justify-content-center ml-2 mr-2">
						<span class="col-1 font-weight-bold">Buscar: </span>
						<input type="text" class="form-control form-control-sm m-0 ml-1 mr-l p-1 col-11" id="buscarTblArt" value=""
							placeholder="Buscar Artículo en la Lista...">
					</div>
				</form>
				<form action="" onsubmit="return false;" class="p-0 m-0" id="frmlstart">
					<table id="tlstArticulos" class="w-100 table table-striped table-hover table-bordered">
						<thead>
							<tr>
								<th width="20%" class="txtcomp text-center bg-warning-gradient">Código</th>
								<th width="60%" class="txtcomp text-center bg-warning-gradient">Descripción</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Vendido</th>
								<th width="10%" class="txtcomp text-center bg-warning-gradient">Entregado</th>
							</tr>
						</thead>
					</table>
				</form>
			</div>
			<div class="modal-footer pt-2 pb-2 align-items-end justify-content-end align-top">
				<button class="btn btn-outline-danger col-3" class="close" data-dismiss="modal" id="btncerrar">
					Cerrar <i class="fas fa-times-circle"></i>
				</button>
			</div>
		</div>
	</div>
</div>

<script>
	var vlocalidad = 0;
	var vtienda = '';
	var vorganizacion = 0;

	$('.modal').modal({backdrop: 'static', keyboard: false, show: false})

	$('#tblDetalle').DataTable({ 
		scrollY: "50vh",
		processing: false,
		ordering: false,
		autoWidth: false,
	}).columns.adjust().draw();

	$('#tblDetalle').DataTable().column(1).visible( $('#movil').val()==0 );
	$('#tblDocumentos').DataTable().column(3).visible( $('#movil').val()==0 );
	$('#tblDocumentos').DataTable().column(4).visible( $('#movil').val()==0 );

	$('#nrodoc').focus();

	$.ajax({
		url: "app/controller/despacho.php",
		data: {
			opcion: "tiendaActiva",
			nrodoc: function() { return $("#nrodoc").val() },
		},
		type: "POST",
		dataType: "json",
		success: function(data) {
			vlocalidad = data[0].codigo;
			vtienda = data[0].nombre;
			$('#ttitulo').html(capitalize(vtienda) + '&nbsp;<sup>['+vlocalidad+']</sup>')
			$('#tblDocumentos').dataTable({
				scrollCollapse: true,
				scrollY: 'auto',
				autoWidth: false,
				processing: false,
				ordering: false,
				ajax: {
					url: "app/controller/despacho.php",
					data: {
						opcion : "cabeceraDocumentos",
						nrodoc : function() { return $("#nrodoc").val().trim() },
						nrocaja: function() { return $("#nrocaja").val().trim() },
						tienda : vlocalidad,
					},
					type: "POST",
					dataType: "json",
					dataSrc: function(json) {
						if($("#nrodoc").val().trim()!='') {
							if( json.data.length==0 ) {
								msg.fire({
									title: '!!! A T E N C I Ó N ¡¡¡',
									icon: 'info',
									html: '<center>Documento '+$("#nrodoc").val().trim()+' no Existe</center>',
									showCancelButton: false,
								})
							} else {
								let usuario = json.data[0].USUARIO;
								let login = usuario.substring(usuario.lastIndexOf(String.fromCharCode(40))+1, usuario.length -1);
								let fecha = moment(json.data[0].FECDOC, 'YYYY-MM-DD HH:mm:ss').format('D [de] MMMM [de] YYYY [a las] h:mm a');
								usuario = usuario.substring(0, usuario.lastIndexOf(String.fromCharCode(40))-1)
								if(json.data[0].STATUS == 2 ) {
									cargando('hide');
									msg.fire({
										title: '!!!! A T E N C I Ó N ¡¡¡¡',
										icon: 'info',
										html: 'El documento ya fue entregado por el usuario <br> '+
												'<b>'+usuario+'</b><br>el día '+fecha,
										showCancelButton: false,
										onAfterClose: function() {
											$("#nrodoc").val([]);
											$("#nrocaja").val([]);
											$("#nrodoc").focus();
										}
									})
									return null
								} else {
									if(login != '' && login != $('#uilogin').val()) {
										cargando('hide');
										msg.fire({
											title: '!!!! A T E N C I Ó N ¡¡¡¡',
											icon: 'info',
											html: 'El documento está en proceso de entrega por el usuario: <br> '+
													'<b>'+usuario+'</b><br>desde el día '+fecha,
											showCancelButton: false,
										})
										return null
									} else if(json.data[0].STATUS == 1) {
										$('#id_cab').val(json.data[0].IDCAB);
										getDeta(json.data[0].DOCUMENTO, json.data[0].LOCALIDAD, json.data[0].CAJA)
									}
									$('#agrArt').attr('disabled', false);
								}
							}
						}
						return json.data;
					},
					complete: function() { cargando('hide'); }
				},
				columns: [
					{ data: 'DOCUMENTO', sClass: "txtcomp align-middle" },
					{ data: 'CAJA', sClass: "txtcomp align-middle" },
					{ data: null,        sClass: "txtcomp align-middle",
						render: function(data) {
							return moment(data.FECDOC, 'YYYY-MM-DD HH:mm:ss').format('DD-MM-YYYY hh:mm')
						}
					},
					{ data: 'IDCLIENTE', sClass: "txtcomp align-middle" },
					{ data: 'RAZON',     sClass: "txtcomp align-middle" },
					{ data: 'TELEFONO',  sClass: "txtcomp align-middle" },			
				],
				rowCallback: function(row, data) {
					if($('#movil').val()==1) {
						var row = $('#tblDocumentos').DataTable().row( row );
						row.child( data.RAZON+'&emsp;&#9742; '+data.TELEFONO ).show();
						$(this).addClass('txtcomp');
					}
				},
			});
		}
	})

	function buscarFactura() {
		if($("#nrodoc").val().trim() == '') {
			$("#nrodoc").focus();
			return false
		}
		if($("#nrocaja").val().trim() == '') {
			$("#nrocaja").focus();
			return false
		}
		cargando('show')
		$('#tblDetalle').dataTable({
			scrollY: "50vh",
			processing: false,
			ordering: false,
			data: [],
			autoWidth: false,
		})
		$('#tblDetalle').DataTable().column(1).visible( $('#movil').val()==0 );
		$('#tblDocumentos').DataTable().ajax.reload();
		$('#tblDocumentos').DataTable().column(3).visible( $('#movil').val()==0 );
		$('#tblDocumentos').DataTable().column(4).visible( $('#movil').val()==0 );
		$('#titems').html('&nbsp;');
		$('#totven').html('&nbsp;');
		$('#totent').html('&nbsp;');
		setTimeout(()=>{ $('#activa'+$("#nrodoc").val().trim()).focus() }, 150);
	}

	$('#TblArt').on('show.bs.modal', function () {
		data = $('#tblDocumentos').DataTable().rows().data()[0];
		$.ajax({
			url: "app/controller/despacho.php",
			data: {
				opcion: "detalleFactura",
				nrodoc: data.DOCUMENTO,
				tienda: data.LOCALIDAD,
				caja  : data.CAJA,
			},
			type: "POST",
			dataType: "json",
			beforeSend: function() { cargando2('show'); },
			success : function(data) {
				$('#tlstArticulos').dataTable({
					scrollY: "50vh",
					scrollCollapse: false,
					data: data,
					autoWidth: false,
					order: [ 1, 'asc'],
					fixedHeader: true,
					columns: [
						{ data: 'CODIGO',   sClass: "txtcomp text-left align-middle" },
						{ data: 'ARTICULO', sClass: "txtcomp text-left align-middle" },
						{ data: 'VENDIDO',  sClass: "txtcomp text-right align-middle", render: $.fn.dataTable.render.number(",", ".", 0) },
						{ data: 'ENTREGADO',  sClass: "txtcomp text-right align-middle", render: $.fn.dataTable.render.number(",", ".", 0) },
					],
				});
			},
			complete: function() { cargando2('hide'); }
		});
	})

	$('#TblArt').on('shown.bs.modal', function () {
		$('#buscarTblArt').val('').focus();
		setTimeout(()=>$('#tlstArticulos').DataTable().columns.adjust().draw(), 100)
	})

	$("#buscarTblArt").keyup(function(e) {
		if(e.which == '13') {
			lstArticulos()
		}
	});

	function addarticulo(nrodoc, codigo, articulo, fecha, vendido, entregado, tienda, caja) {
		if($('#id_cab').val()=='') {
			$.ajax({
				url: "app/controller/despacho.php",
				data: {
					opcion: "crearDespachoCab",
					userid: $('#uinombre').val().toUpperCase() + ' (' + $('#uilogin').val() + ')',
					nrodoc: nrodoc,
					caja  : caja,
					tienda: tienda,
					fecdoc: fecha,
				},
				type: "POST",
				dataType: "text",
				success : function(data) {
					data = data.split('¬')
					if(data[0]==0 ) {
						msg.fire({
							title: '!!! A T E N C I Ó N ¡¡¡',
							icon: 'error',
							html: data[1],
							showCancelButton: false,
						})
						$('#id_cab').val('')
					} else {
						$('#id_cab').val(data[0]);
						agregaArticulo(data[0], nrodoc, codigo, articulo, fecha, vendido, entregado, tienda, caja);
					}
				}
			})
		} else {
			agregaArticulo($('#id_cab').val(), nrodoc, codigo, articulo, fecha, vendido, entregado, tienda, caja);
		}
		$('#TblArt').modal('hide');
		setTimeout(function() {
			$('#inpund'+codigo).focus().select();
		}, 400);
	}

	function agregaArticulo(id_cab, nrodoc, codigo, articulo, fecha, vendido, entregado, tienda, caja) {
		if($('#inpund'+codigo).length == 0) {
			$.ajax({
				url: "app/controller/despacho.php",
				data: {
					opcion : "agregaArtDesp",
					id_cab : id_cab,
					codigo : codigo,
					vendido: vendido,
					entrega: entregado,
					nrodoc : nrodoc,
					tienda : tienda,
					caja   : caja,					
				},
				type: "POST",
				dataType: "text",
				success : function(data) {
					data = data.split('¬')
					if(data[0]==1) {
						getDeta(nrodoc, tienda, caja)
					} else {
						msg.fire({
							title: '!!! A T E N C I Ó N ¡¡¡',
							icon: 'error',
							html: data[1],
							showCancelButton: false,
						})
					}
				}
			})
		}
	}

	function delArticulo(objeto, codigo, id_cab) {
		$.ajax({
			url: "app/controller/despacho.php",
			data: {
				opcion: "delArtDesp",
				id_cab: id_cab,
				codigo: codigo,
			},
			type: "POST",
			dataType: "text",
			success : function(data) {
				data = data.split('¬')
				if(data[0]==0 ) {
					msg.fire({
						title: '!!! A T E N C I Ó N ¡¡¡',
						icon: 'error',
						html: data[1],
						showCancelButton: false,
					})
				} else {
					$('#tblDetalle').DataTable().row($(objeto).parents('tr')).remove().draw(false);
					calTotales();
				}
			}
		})
	}

	function getDeta(nrodoc, tienda, caja){
		cargando('show');
		tomar_datos = $.ajax({
			url: "app/controller/despacho.php",
			data: {
				opcion: "detalleDocumento",
				nrodoc: nrodoc,
				tienda: tienda,
				caja  : caja,
			},
			type: "POST",
			dataType: "json",
			success : function(data) {
				$('#tblDetalle').dataTable({
					scrollY: "50vh",
					processing: false,
					ordering: false,
					data: data,
					autoWidth: false,
					columns: [
						{ data: 'codigo', sClass: "txtcomp text-left text-nowrap align-middle" },
						{ data: 'nombre', sClass: "txtcomp text-left align-middle" },
						{ data: 'vendido', sClass: "txtcomp text-right align-middle" },
						{ data: 'pendiente', sClass: "txtcomp text-right align-middle" },
						{ data: null,
							render: function(data, type, row, meta){
								var txt0 = '';
								var txt1 = '';
								txt0 += '<div id="txt0'+data.codigo+'" class="d-none align-items-baseline justify-content-center">';
								txt1 += '<div id="txt1'+data.codigo+'" class="d-flex align-items-baseline justify-content-center">';
								txt0 += data.cantidad + '</div>';
								txt1 += '<button class="btn btn-warning btn-sm pt-0 pb-0 w-100 font-weight-bold" '+
											'id="inpund'+data.codigo+'" data-val="'+data.cantidad+'" '+
											'onclick="modificaCant('+
												data.id_cab+","+data.codigo+",'"+data.nombre+"',"+data.pendiente+')">'+
											data.cantidad+
										'</button>'+
									'</div>';
								if($('#movil').val()==1) {
									return txt0+txt1
								} else {
									return	'<input type="number" min="0" step="1" max="'+data.pendiente+'"'+
											' onblur = "'+
											' 	if( $(this).val()==null || $(this).val()==0 ) {' +
											'		$(this).val('+data.cantidad+');'+
											'	} else if($(this).val()>'+data.pendiente+'){'+
											'		$(this).val('+data.cantidad+');'+
											'	};'+
											' 	resaltar(this,0);'+
											'	modCantidad('+data.id_cab+','+"'"+data.codigo+"', "+' this.value)"'+
											' onkeyup="if(event.keyCode==13) { $(this).blur() }"'+
											' onfocus="$(this).select(); resaltar(this,1);"' +
											' data-val="'+data.cantidad+'"'+
											' id="inpund'+data.codigo+'" '+
											' value="'+data.cantidad+'" class="p-0 m-0 text-center" style="width: 75px;">';
								}
							},
							sClass: "txtcomp m-0 p-0 text-center  align-middle border border-top-0 border-bottom-0",
						},
						{ data: null, sClass: "text-center",
							render: function(data,type){
								var codigo =  '<i class="fas fa-trash-alt text-danger" '+
									'title="Eliminar Artículo" style="cursor: pointer;"'+
									' onclick="delArticulo(this, '+data.codigo+','+data.id_cab+')"></i>';
								return codigo
							}
						},
					],
					rowCallback: function(row, data) {
						if($('#movil').val()==1) {
							var row = $('#tblDetalle').DataTable().row( row );
							row.child( data.nombre ).show();
							$(this).addClass('txtcomp');
						}
					},
					initComplete: function() {
						$('#tblDetalle').DataTable().column(1).visible( $('#movil').val()==0 );
					},
				});
			}
		}).done(function() { calTotales(); cargando('hide'); });	
	}

	function modCantidad(id_cab, codigo, valor) {
		$.ajax({
				url: "app/controller/despacho.php",
				data: {
				opcion: "modCantidad",
				id_cab: id_cab,
				codigo: codigo,
				valor : valor,
			},
			type: "POST",
			dataType: "text",
			success : function(data) {
				data = data.split('¬');
				if(data[0]==0 ) {
					msg.fire({
						title: '!!! A T E N C I Ó N ¡¡¡',
						icon: 'error',
						html: data[1],
						showCancelButton: false,
					})
				} else {
					$('#inpund'+codigo).data('val', valor);
					calTotales()
				}
			}
		})
	}

	function calTotales() {
		var titem = 0;
		var toven = 0;
		var toent = 0;
		datos = $('#tblDetalle').DataTable().rows().data();
		$.each(datos, function(idx, val) { 
			titem++;
			toven+= val.vendido*1;
			toent+= ($('#inpund'+val.codigo).data('val')*1)
		})
		$('#titems').html(titem)
		$('#totven').html(toven)
		$('#totent').html(toent)
		$('#procEntrega').attr('disabled', toent==0)
	}

	function modificaCant(nrodoc, codigo, nombre, vendido) {
		msg.fire({
			title: 'Modificar Cantidad',
			icon: 'question',
			html: '<b>'+nombre+'</b>',
			input: 'number',
			inputValue: $('#inpund'+codigo).html(),
			inputAttributes: {
				autocapitalize: 'off',
				min: 1,
				step: 1
			},
			inputValidator: (value) => {
				if (value > vendido) {
					return 'La cantidad ' + value + ' es mayor a lo vendido ' + vendido
				}
			},
			onOpen: () => {
				Swal.getContent().querySelector('.swal2-input').select()
			}
		}).then((result) => {
			if (result.value) {
				modCantidad(nrodoc, codigo, result.value);
				$('#inpund'+codigo).html(result.value);
				$('#inpund'+codigo).data('val', result.value);
			}
		})
	}

	function procEntrega() {
		if(($('#totent').html()*1)>0) {
			cargando2('show');
			$.ajax({
				url: "app/controller/despacho.php",
				data: {
					opcion: "procEntrega",
					id_cab: $('#id_cab').val(),
					userid: $('#uinombre').val().toUpperCase() + ' (' + $('#uilogin').val() + ')',
					orgaid: vorganizacion,
				},
				type: "POST",
				dataType: "text",
				success: function(data) {
					data = data.split('¬')
					if(data[0]==0) {
						msg.fire({
							title: '!!! A T E N C I Ó N ¡¡¡',
							icon: 'error',
							html: data[1],
							showCancelButton: false,
						}).then((result) => {
							if (result.value) {
								return false;
							}
						})
					} else {
						msg.fire({
							title: 'Documento Procesado',
							icon: 'success',
							html: 'documento Procesado con Éxito',
							showCancelButton: false,
							onAfterClose: function() {
								$('#contenido_ppal').load('app/db_despacho.html?t=' + moment().format("HH:mm:ss"));
							}
						})
					}
					cargando2('hide');
				}
			});
		}
	}

	function resaltar(elem, valor) {
		if(valor==1) {
			$(elem).parent().parent().addClass('current-row').animate( { color: 'white', fontWeight: '900' }, '900' );
		} else {
			$(elem).parent().parent().removeClass('current-row').animate( { color: 'black', fontWeight: '400' }, '900' );
		}
	}
</script>